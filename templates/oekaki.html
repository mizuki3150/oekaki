<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>キャラクター図鑑メーカー（前端）</title>
  <!-- Flaskで配信する静的CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles_oekaki.css') }}">
</head>
<body>
  <main class="container">
    <h1 class="title">キャラクター図鑑メーカー</h1>

    <section class="canvas-area">
      <div class="tools flex flex-wrap gap-2 mb-4">
        <label>色:
          <input id="color" type="color" value="#000000" />
        </label>
        <label>太さ:
          <input id="size" type="range" min="1" max="40" value="4" />
        </label>
        <button id="undo">1つ前に戻る</button>
        <button id="clear">すべて消す</button>
        <button id="download">保存する</button>
        <button id="goDex">図鑑へ</button>
      </div>

      <div class="canvas-wrap">
        <canvas id="paint" width="600" height="420" aria-label="お絵かきキャンバス"></canvas>
      </div>
    </section>

    <section class="meta-area">
      <form id="submitForm">
        <div class="field">
          <label for="charName">キャラクター名</label>
          <input id="charName" name="name" type="text" placeholder="例：もふもふネコ" required />
        </div>

        <div class="field">
          <label for="prompt">補足メモ（AIに渡すヒント）</label>
          <input id="prompt" name="hint" type="text" placeholder="性格や特徴（任意）: 例：いたずら好きで好奇心旺盛" />
        </div>

        <div class="actions">
          <button id="previewBtn" type="button">プレビュー</button>
          <button id="submitBtn" type="submit">バックエンドへ送信</button>
        </div>
      </form>

      <div id="preview" class="preview">
        <p>プレビュー</p>
        <img id="previewImg" alt="描画プレビュー" />
        <p id="previewName"></p>
        <p id="previewHint" class="hint"></p>
      </div>
    </section>

    <footer class="footnote">
      <small>※絵と名前を決めたらバックエンドに送信して、図鑑を見てみよう！</small>
    </footer>
  </main>

  <script>
    // 基本要素取得
    const canvas = document.getElementById('paint');
    const ctx = canvas.getContext('2d');
    const colorEl = document.getElementById('color');
    const sizeEl = document.getElementById('size');
    const clearBtn = document.getElementById('clear');
    const downloadBtn = document.getElementById('download');
    const goDexBtn = document.getElementById('goDex');
    const undoBtn = document.getElementById('undo');

    const previewBtn = document.getElementById('previewBtn');
    const previewImg = document.getElementById('previewImg');
    const previewName = document.getElementById('charName');
    const previewHint = document.getElementById('prompt');
    const submitForm = document.getElementById('submitForm');

    // 描画ステート
    let drawing = false;
    let lastX = 0, lastY = 0;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.strokeStyle = colorEl.value;
    ctx.lineWidth = sizeEl.value;

    const history = [];
    function pushHistory() {
      if (history.length >= 20) history.shift();
      history.push(canvas.toDataURL());
    }
    pushHistory();

    function startDraw(x, y) {
      drawing = true;
      lastX = x;
      lastY = y;
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function drawTo(x, y) {
      if (!drawing) return;
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x;
      lastY = y;
    }

    function endDraw() {
      if (drawing) {
        drawing = false;
        ctx.closePath();
        pushHistory();
      }
    }

    // マウス操作
    canvas.addEventListener('mousedown', (e) => {
      const r = canvas.getBoundingClientRect();
      startDraw(e.clientX - r.left, e.clientY - r.top);
    });
    canvas.addEventListener('mousemove', (e) => {
      const r = canvas.getBoundingClientRect();
      drawTo(e.clientX - r.left, e.clientY - r.top);
    });
    window.addEventListener('mouseup', endDraw);

    // タッチ操作
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const t = e.touches[0];
      const r = canvas.getBoundingClientRect();
      startDraw(t.clientX - r.left, t.clientY - r.top);
    }, { passive: false });
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const t = e.touches[0];
      const r = canvas.getBoundingClientRect();
      drawTo(t.clientX - r.left, t.clientY - r.top);
    }, { passive: false });
    window.addEventListener('touchend', endDraw);

    // ツール操作
    colorEl.addEventListener('change', () => ctx.strokeStyle = colorEl.value);
    sizeEl.addEventListener('input', () => ctx.lineWidth = sizeEl.value);

    clearBtn.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      pushHistory();
    });

    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = (previewName.value || 'drawing') + '.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    goDexBtn.addEventListener('click', () => {
      window.location.href = '/dex';
    });

    undoBtn.addEventListener('click', () => {
      if (history.length > 1) {
        history.pop();
        const prev = history[history.length - 1];
        const img = new Image();
        img.onload = function () {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        }
        img.src = prev;
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    });

    // プレビュー
    previewBtn.addEventListener('click', () => {
      const data = canvas.toDataURL('image/png');
      previewImg.src = data;
      document.getElementById('previewName').textContent = previewName.value || '（名前未入力）';
      document.getElementById('previewHint').textContent = previewHint.value || '';
    });

    // フォーム送信
    submitForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = previewName.value;
      const hint = previewHint.value;
      const imageData = canvas.toDataURL('image/png');

      const formData = new FormData();
      formData.append('name', name);
      formData.append('hint', hint);
      formData.append('imageData', imageData);

      try {
        const res = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });

        const result = await res.json();

        if (res.ok) {
          alert(`「${name || 'キャラクター'}」の図鑑生成が完了しました！`);
          // プレビューリセット
          previewImg.src = '';
          document.getElementById('previewName').textContent = '';
          document.getElementById('previewHint').textContent = '';
        } else {
          alert("送信に失敗しました。\n" + (result.error || '不明なエラー'));
        }
      } catch (err) {
        alert("サーバーに接続できませんでした");
        console.error(err);
      }
    });

    // 白背景
    function fillWhiteBackground() {
      ctx.save();
      ctx.globalCompositeOperation = 'destination-over';
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.restore();
      pushHistory();
    }

    (function init() {
      fillWhiteBackground();
    })();
  </script>
</body>
</html>
